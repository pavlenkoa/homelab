# Vault Secrets Generator - Demo deployment
# Showcases various VSG features for declarative secret management

image:
  tag: "latest"

# Service account name must match *-secret-generator pattern for Vault role
serviceAccount:
  name: "vsg-secret-generator"

vault:
  address: "http://vault.vault.svc.cluster.local:8200"

auth:
  method: kubernetes
  kubernetes:
    role: "secret-generator"

# Demo configuration showcasing VSG features
config:
  inline: |
    vault {
      address = "http://vault.vault.svc.cluster.local:8200"
      auth {
        method = "kubernetes"
        role   = "secret-generator"
      }
    }

    # Default password policy
    defaults {
      generate {
        length     = 32
        digits     = 5
        symbols    = 5
        symbol_set = "-_$@"
      }
    }

    # Demo secret block with various value types
    secret "kv/vsg-demo" {
      # Generated passwords with different policies
      api_key          = generate()
      jwt_secret       = generate({length = 64, symbols = 0})
      database_password = generate({length = 24, digits = 4, symbols = 2})
      simple_token     = generate({length = 16, symbols = 0, no_upper = true})

      # Command-generated values
      uuid             = command("cat /proc/sys/kernel/random/uuid")
      hostname         = command("hostname")
      random_hex       = command("head -c 16 /dev/urandom | od -An -tx1 | tr -d ' \\n'")
      timestamp        = command("date -u +%Y-%m-%dT%H:%M:%SZ")

      # Static configuration values
      environment      = "homelab"
      cluster_name     = "orbstack"
      managed_by       = "vault-secrets-generator"

      # Environment variable references
      namespace        = env("POD_NAMESPACE")
      pod_name         = env("POD_NAME")
      node_name        = env("NODE_NAME")

      # Copy from another Vault secret
      shared_password  = vault("kv/shared", "password")
    }

    # Separate secret block for app-specific config
    secret "kv/vsg-demo/database" {
      host     = "postgres.database.svc.cluster.local"
      port     = "5432"
      username = "app_user"
      password = generate({length = 32})
      ssl_mode = "require"
    }

    # Redis configuration example
    secret "kv/vsg-demo/redis" {
      host     = "redis.cache.svc.cluster.local"
      port     = "6379"
      password = generate({length = 24, symbols = 0})
      db       = "0"
    }

# Environment variables for the job
env:
  - name: POD_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace
  - name: POD_NAME
    valueFrom:
      fieldRef:
        fieldPath: metadata.name
  - name: NODE_NAME
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName

# Job settings
job:
  ttlSecondsAfterFinished: 600
  backoffLimit: 3

resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 50m
    memory: 64Mi
