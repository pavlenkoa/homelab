# ArgoCD configuration for homelab cluster
# Environment-specific overrides only

argo-cd:
  # Bootstrap app-of-apps using Job hook - creates once and deletes itself
  extraObjects:
    - apiVersion: batch/v1
      kind: Job
      metadata:
        name: argocd-bootstrap
        namespace: argocd
        annotations:
          "helm.sh/hook": post-install
          "helm.sh/hook-weight": "10"
          "helm.sh/hook-delete-policy": hook-succeeded
      spec:
        template:
          spec:
            serviceAccountName: argocd-application-controller
            restartPolicy: Never
            containers:
            - name: create-app-of-apps
              image: bitnami/kubectl:latest
              command:
              - /bin/sh
              - -c
              - |
                echo "→ Checking if app-of-apps already exists..."
                if kubectl get application app-of-apps -n argocd >/dev/null 2>&1; then
                  echo "✔ App-of-apps already exists, skipping creation"
                  exit 0
                fi

                echo "→ Waiting for ArgoCD to be ready..."
                echo "→ Waiting for ArgoCD server deployment..."
                if ! kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd; then
                  echo "✗ ArgoCD server failed to become ready"
                  exit 1
                fi

                echo "→ Waiting for ArgoCD application controller..."
                if ! kubectl wait --for=condition=ready --timeout=300s pod/argocd-application-controller-0 -n argocd; then
                  echo "✗ ArgoCD application controller failed to become ready"
                  exit 1
                fi

                echo "→ Waiting for ArgoCD repo server..."
                if ! kubectl wait --for=condition=available --timeout=300s deployment/argocd-repo-server -n argocd; then
                  echo "✗ ArgoCD repo server failed to become ready"
                  exit 1
                fi

                echo "✔ All ArgoCD components are ready, creating app-of-apps Application..."
                cat <<EOF | kubectl apply -f -
                apiVersion: argoproj.io/v1alpha1
                kind: Application
                metadata:
                  name: app-of-apps
                  namespace: argocd
                  finalizers:
                    - resources-finalizer.argocd.argoproj.io
                spec:
                  project: default
                  source:
                    repoURL: https://github.com/pavlenkoa/homelab.git
                    targetRevision: HEAD
                    path: kubernetes/app-of-apps
                    helm:
                      valueFiles:
                        - values/homelab.yaml
                  destination:
                    server: https://kubernetes.default.svc
                    namespace: argocd
                  syncPolicy:
                    automated:
                      prune: true
                      selfHeal: true
                    syncOptions:
                      - "CreateNamespace=true"
                      - "ServerSideApply=true"
                      - "ServerSideDiff=true"
                    retry:
                      limit: 3
                      backoff:
                        duration: "5s"
                        factor: 2
                        maxDuration: "2m"
                EOF
                echo "✔ App-of-apps created successfully!"

  # Server configuration
  server:
    ingress:
      enabled: true
      ingressClassName: "nginx"
      hostname: "argocd.pavlenko.io"
      pathType: ImplementationSpecific
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
      extraTls:
      - secretName: argocd-server-tls
        hosts:
        - "argocd.pavlenko.io"

  configs:
    cm:
      url: "https://argocd.pavlenko.io"

    # Git repositories configuration
    repositories:
      homelab:
        url: https://github.com/pavlenkoa/homelab.git
        type: git
        name: homelab
