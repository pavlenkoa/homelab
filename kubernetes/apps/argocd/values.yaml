# Wrapper chart for argo-cd
# Defaults here, environment-specific overrides in values/homelab.yaml

argo-cd:
  # Override name to "argocd" instead of "argo-cd" for consistent naming
  nameOverride: argocd

  # ArgoCD configuration via configs section
  configs:
    params:
      # Allow insecure (TLS termination at ingress)
      server.insecure: true

    cm:
      # Resource exclusions - override default to exclude only Endpoints (not EndpointSlice)
      resource.exclusions: |
        ### Network resources created by the Kubernetes control plane (keeping only Endpoints excluded)
        - apiGroups:
          - ''
          kinds:
          - Endpoints
        ### Internal Kubernetes resources excluded reduce the number of watched events
        - apiGroups:
          - coordination.k8s.io
          kinds:
          - Lease
        ### Internal Kubernetes Authz/Authn resources excluded reduce the number of watched events
        - apiGroups:
          - authentication.k8s.io
          - authorization.k8s.io
          kinds:
          - SelfSubjectReview
          - TokenReview
          - LocalSubjectAccessReview

      # Resource customizations
      resource.customizations: |
        argoproj.io/Application:
          health.lua: |
            hs = {}
            hs.status = "Progressing"
            hs.message = ""
            if obj.status ~= nil then
              if obj.status.health ~= nil then
                hs.status = obj.status.health.status
                if obj.status.health.message ~= nil then
                  hs.message = obj.status.health.message
                end
              end
            end
            return hs

      # Global ignore differences for common Kubernetes normalization issues
      resource.customizations.ignoreDifferences.all: |
        jsonPointers:
        - /metadata/generation
        managedFieldsManagers:
        - kube-controller-manager

      # StatefulSet volumeClaimTemplates normalization
      resource.customizations.ignoreDifferences.apps_StatefulSet: |
        jqPathExpressions:
        - .spec.volumeClaimTemplates[].apiVersion
        - .spec.volumeClaimTemplates[].kind

      # Webhook CA bundle changes (managed by cert-manager)
      resource.customizations.ignoreDifferences.admissionregistration.k8s.io_MutatingWebhookConfiguration: |
        jqPathExpressions:
        - .webhooks[]?.clientConfig.caBundle

      resource.customizations.ignoreDifferences.admissionregistration.k8s.io_ValidatingWebhookConfiguration: |
        jqPathExpressions:
        - .webhooks[]?.clientConfig.caBundle

  # Controller configuration
  controller:
    resources:
      limits:
        memory: 512Mi
      requests:
        memory: 256Mi

  # Repo server configuration
  repoServer:
    resources:
      limits:
        memory: 256Mi
      requests:
        memory: 128Mi

  # Application set controller
  applicationSet:
    enabled: true
    resources:
      limits:
        memory: 128Mi
      requests:
        memory: 64Mi

  # Notifications controller
  notifications:
    enabled: false

  # Redis configuration
  redis:
    resources:
      limits:
        memory: 128Mi
      requests:
        memory: 64Mi
