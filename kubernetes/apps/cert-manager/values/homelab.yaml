# cert-manager configuration for homelab cluster
# Environment-specific overrides only

cert-manager:
  # Extra objects - ExternalSecret for Cloudflare API token and ClusterIssuer
  extraObjects:
    - |
      apiVersion: external-secrets.io/v1
      kind: ExternalSecret
      metadata:
        name: cloudflare-api-token
        namespace: cert-manager
      spec:
        refreshInterval: 1h
        secretStoreRef:
          name: vault-backend
          kind: ClusterSecretStore
        target:
          name: cloudflare-api-token
          creationPolicy: Owner
        data:
        - secretKey: api-token
          remoteRef:
            key: cloudflare
            property: api-token
            conversionStrategy: Default
            decodingStrategy: None
            metadataPolicy: None
    - |
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: letsencrypt-prod
        annotations:
          argocd.argoproj.io/sync-wave: "20"  # Apply after ExternalSecret creates the secret
      spec:
        acme:
          server: https://acme-v02.api.letsencrypt.org/directory
          email: contact@pavlenko.io
          privateKeySecretRef:
            name: letsencrypt-prod
          solvers:
          - dns01:
              cloudflare:
                apiTokenSecretRef:
                  name: cloudflare-api-token
                  key: api-token
            selector:
              dnsZones:
              - "pavlenko.io"
