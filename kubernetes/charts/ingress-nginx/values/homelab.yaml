# ingress-nginx configuration for k3s in OrbStack VM
# Uses hostNetwork so nginx binds to 0.0.0.0:80/443, which OrbStack forwards to LAN

ingress-nginx:
  controller:
    # hostNetwork binds nginx directly to VM's network interface
    # OrbStack forwards 0.0.0.0 bindings to Mac's LAN IP (192.168.88.2)
    hostNetwork: true
    hostPort:
      enabled: true
    dnsPolicy: ClusterFirstWithHostNet

    # Service still useful for internal cluster access
    service:
      type: ClusterIP

    # Enable additional features
    enableAnnotationValidations: true

    # Metrics and monitoring (disabled for now - no Prometheus Operator installed)
    metrics:
      enabled: false

    # Resource limits
    resources:
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 100m
        memory: 128Mi

    # Only 1 replica - port 80/443 conflict with hostNetwork
    replicaCount: 1

    # PDB disabled with single replica
    podDisruptionBudget:
      enabled: false

    # Pin to macmini node (the one with OrbStack LAN forwarding)
    nodeSelector:
      kubernetes.io/hostname: macmini

    # Additional configuration
    config:
      # Enable real IP forwarding
      use-forwarded-headers: "true"
      compute-full-forwarded-for: "true"

      # SSL configuration
      ssl-protocols: "TLSv1.2 TLSv1.3"
      ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256,ECDHE-RSA-AES128-GCM-SHA256,ECDHE-ECDSA-AES256-GCM-SHA384,ECDHE-RSA-AES256-GCM-SHA384"

      # Performance tuning
      worker-processes: "auto"
      max-worker-connections: "16384"

  # Default backend service
  defaultBackend:
    enabled: true
    resources:
      limits:
        cpu: 50m
        memory: 64Mi
      requests:
        cpu: 10m
        memory: 20Mi

  # Admission webhooks
  admissionWebhooks:
    enabled: true
    resources:
      limits:
        cpu: 50m
        memory: 64Mi
      requests:
        cpu: 10m
        memory: 20Mi
