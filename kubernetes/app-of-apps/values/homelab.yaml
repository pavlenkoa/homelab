# App-of-Apps configuration for homelab cluster
# This defines which applications ArgoCD should deploy

# Global defaults for all projects and applications
global:
  repository:
    url: "https://github.com/pavlenkoa/homelab.git"
    targetRevision: "HEAD"
  
  destination:
    server: "https://kubernetes.default.svc"
  
  # Default finalizers for applications
  finalizers:
    - "resources-finalizer.argocd.argoproj.io"
  
  # Base sync policy for all applications (can be overridden per project/app)
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - "CreateNamespace=true"
      - "PrunePropagationPolicy=foreground"
      - "PruneLast=true"
      - "ServerSideApply=true"
      - "ServerSideDiff=true"
    retry:
      limit: 3  # Fewer retries for faster feedback
      backoff:
        duration: "5s"
        factor: 2
        maxDuration: "2m"

# Infrastructure project - Core cluster services
infrastructure:
  description: "Core cluster infrastructure (CNI, ingress, storage)"
  # Override sync policy for infrastructure safety
  syncPolicy:
    automated:
      prune: false  # Never auto-prune CNI
      selfHeal: true
  applications:
    - name: cert-manager
      enabled: true  # Certificate management for TLS
      path: kubernetes/infrastructure/charts/cert-manager
      namespace: cert-manager
      helm:
        valueFiles:
          - ../../values/homelab/cert-manager.yaml
    
    - name: ingress-nginx
      enabled: true  # Ingress controller for external access
      path: kubernetes/infrastructure/charts/ingress-nginx
      namespace: ingress-nginx
      helm:
        valueFiles:
          - ../../values/homelab/ingress-nginx.yaml

# Platform project - DevOps and management services  
platform:
  description: "Platform services and DevOps tools"
  # Platform apps inherit global sync policy (prune: true, selfHeal: true)
  applications:
    - name: argocd
      enabled: true  # Now self-managed via GitOps
      path: kubernetes/platform/charts/argocd
      namespace: argocd
      helm:
        valueFiles:
          - ../../values/homelab/argocd.yaml
      # Override for ArgoCD safety
      syncPolicy:
        automated:
          prune: false  # Never auto-prune ArgoCD itself

    - name: vault
      enabled: true
      path: kubernetes/platform/charts/vault
      namespace: vault
      helm:
        valueFiles:
          - ../../values/homelab/vault.yaml

    - name: external-secrets
      enabled: true
      path: kubernetes/platform/charts/external-secrets
      namespace: external-secrets
      helm:
        valueFiles:
          - ../../values/homelab/external-secrets.yaml

    - name: victoriametrics
      enabled: true
      path: kubernetes/platform/charts/victoria-metrics-single
      namespace: monitoring
      helm:
        valueFiles:
          - ../../values/homelab/victoriametrics.yaml

    - name: victorialogs
      enabled: false
      path: kubernetes/platform/charts/victorialogs
      namespace: monitoring
      helm:
        valueFiles:
          - ../../values/homelab/victorialogs.yaml

    - name: grafana
      enabled: false
      path: kubernetes/platform/charts/grafana
      namespace: monitoring
      helm:
        valueFiles:
          - ../../values/homelab/grafana.yaml

    - name: alloy
      enabled: false
      path: kubernetes/platform/charts/alloy
      namespace: monitoring
      helm:
        valueFiles:
          - ../../values/homelab/alloy.yaml

# Applications project - End-user applications
applications:
  description: "End-user applications and services"
  # Applications inherit global sync policy (prune: true, selfHeal: true)
  applications:
    - name: external-services
      enabled: true
      path: kubernetes/applications/charts/external-services
      namespace: external-services
      helm:
        valueFiles:
          - ../../values/homelab/external-services.yaml

    - name: authelia
      enabled: false
      path: kubernetes/platform/charts/authelia
      namespace: authelia
      helm:
        valueFiles:
          - ../../values/homelab/authelia.yaml

    - name: immich
      enabled: false
      path: kubernetes/applications/charts/immich
      namespace: immich
      helm:
        valueFiles:
          - ../../values/homelab/immich.yaml

    - name: emby
      enabled: false
      path: kubernetes/applications/charts/emby
      namespace: emby
      helm:
        valueFiles:
          - ../../values/homelab/emby.yaml
