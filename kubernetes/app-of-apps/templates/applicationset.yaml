{{/*
ApplicationSet - only rendered at root level (when renderProject is empty)
Generates one Application per project (system-apps, platform-apps, applications-apps)
Each generated Application uses the same chart with renderProject parameter set
*/}}
{{- if not .Values.global.renderProject }}
{{- $global := .Values.global }}
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {{ $global.environmentName }}-apps
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          {{- range $projectName, $projectConfig := (omit .Values "global") }}
          - project: {{ $projectName }}
            wave: {{ (index ($projectConfig.annotations | default dict) "argocd.argoproj.io/sync-wave") | default "0" | quote }}
            {{- if ($projectConfig.repository).url }}
            repoURL: {{ $projectConfig.repository.url }}
            {{- else }}
            repoURL: {{ $global.repository.url }}
            {{- end }}
            {{- if ($projectConfig.repository).targetRevision }}
            targetRevision: {{ $projectConfig.repository.targetRevision }}
            {{- else }}
            targetRevision: {{ $global.repository.targetRevision }}
            {{- end }}
            {{- if ($projectConfig.destination).server }}
            destServer: {{ $projectConfig.destination.server }}
            {{- else }}
            destServer: {{ $global.destination.server }}
            {{- end }}
          {{- end }}
  template:
    metadata:
      name: '{{`{{project}}`}}-apps'
      annotations:
        argocd.argoproj.io/sync-wave: '{{`{{wave}}`}}'
    spec:
      project: default
      source:
        repoURL: '{{`{{repoURL}}`}}'
        targetRevision: '{{`{{targetRevision}}`}}'
        path: kubernetes/app-of-apps
        helm:
          valueFiles:
            - values/{{ $global.environmentName }}.yaml
          parameters:
            - name: global.renderProject
              value: '{{`{{project}}`}}'
      destination:
        server: '{{`{{destServer}}`}}'
        namespace: argocd
      syncPolicy:
        syncOptions:
          {{- range $global.syncPolicy.syncOptions }}
          - {{ . }}
          {{- end }}
{{- end }}
