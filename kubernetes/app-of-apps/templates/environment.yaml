{{/*
Environment resources - rendered at root level (when renderLayer is empty)
Creates ApplicationSet that generates:
  1. Environment project app (e.g., "homelab-project" with wave -10)
  2. Layer apps (e.g., "homelab-system", "homelab-platform", "homelab-applications")
*/}}
{{- if not .Values.global.renderLayer }}
{{- $global := .Values.global }}
{{- $envName := $global.environmentName }}
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {{ $envName }}-layers
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          # Environment project (created first)
          - layer: _project
            wave: "-10"
            repoURL: {{ $global.repository.url }}
            targetRevision: {{ $global.repository.targetRevision }}
            destServer: {{ $global.destination.server }}
          # Layer apps
          {{- range $layerName, $layerConfig := .Values.layers }}
          {{- if ne $layerConfig.enabled false }}
          - layer: {{ $layerName }}
            wave: {{ (index ($layerConfig.annotations | default dict) "argocd.argoproj.io/sync-wave") | default "0" | quote }}
            {{- if ($layerConfig.repository).url }}
            repoURL: {{ $layerConfig.repository.url }}
            {{- else }}
            repoURL: {{ $global.repository.url }}
            {{- end }}
            {{- if ($layerConfig.repository).targetRevision }}
            targetRevision: {{ $layerConfig.repository.targetRevision }}
            {{- else }}
            targetRevision: {{ $global.repository.targetRevision }}
            {{- end }}
            {{- if ($layerConfig.destination).server }}
            destServer: {{ $layerConfig.destination.server }}
            {{- else }}
            destServer: {{ $global.destination.server }}
            {{- end }}
          {{- end }}
          {{- end }}
  template:
    metadata:
      name: '{{ $envName }}-{{`{{layer}}`}}'
      annotations:
        argocd.argoproj.io/sync-wave: '{{`{{wave}}`}}'
    spec:
      project: default
      source:
        repoURL: '{{`{{repoURL}}`}}'
        targetRevision: '{{`{{targetRevision}}`}}'
        path: kubernetes/app-of-apps
        helm:
          valueFiles:
            - values/{{ $envName }}.yaml
          parameters:
            - name: global.renderLayer
              value: '{{`{{layer}}`}}'
      destination:
        server: '{{`{{destServer}}`}}'
        namespace: argocd
      syncPolicy:
        syncOptions:
          {{- range $global.syncPolicy.syncOptions }}
          - {{ . }}
          {{- end }}
{{- end }}
