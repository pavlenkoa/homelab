{{/*
Environment resources - rendered at root level (when renderLayer is empty)
Creates:
  1. AppProject for the environment (wave -10)
  2. Layer Applications (system, platform, applications)

Same pattern as layer.yaml which creates:
  1. AppProject for the layer
  2. Child Applications
*/}}
{{- if not .Values.global.renderLayer }}
{{- $global := .Values.global }}
{{- $envName := $global.environmentName }}
---
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: {{ $envName }}
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "-10"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  description: "Environment: {{ $envName }}"
  sourceRepos:
    - {{ $global.repository.url }}
    {{- range $layerName, $layerConfig := .Values.layers }}
    {{- range ($layerConfig.sourceRepos | default list) }}
    - {{ . }}
    {{- end }}
    {{- end }}
  destinations:
    - namespace: "*"
      server: {{ $global.destination.server }}
  clusterResourceWhitelist:
    - group: "*"
      kind: "*"
  namespaceResourceWhitelist:
    - group: "*"
      kind: "*"
  roles: []
{{- range $layerName, $layerConfig := .Values.layers }}
{{- if ne $layerConfig.enabled false }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $layerName }}
  namespace: argocd
  {{- if $layerConfig.annotations }}
  annotations:
    {{- toYaml $layerConfig.annotations | nindent 4 }}
  {{- end }}
  finalizers:
    {{- range ($global.finalizers) }}
    - {{ . }}
    {{- end }}
spec:
  project: {{ $envName }}
  source:
    repoURL: {{ ($layerConfig.repository).url | default $global.repository.url }}
    targetRevision: {{ ($layerConfig.repository).targetRevision | default $global.repository.targetRevision }}
    path: kubernetes/app-of-apps
    helm:
      valueFiles:
        - values/{{ $envName }}.yaml
      parameters:
        - name: global.renderLayer
          value: {{ $layerName }}
  destination:
    server: {{ ($layerConfig.destination).server | default $global.destination.server }}
    namespace: argocd
  syncPolicy:
    {{- if $layerConfig.syncPolicy }}
    {{- if $layerConfig.syncPolicy.automated }}
    automated:
      prune: {{ $layerConfig.syncPolicy.automated.prune | default false }}
      selfHeal: {{ $layerConfig.syncPolicy.automated.selfHeal | default false }}
    {{- end }}
    {{- end }}
    syncOptions:
      {{- range $global.syncPolicy.syncOptions }}
      - {{ . }}
      {{- end }}
{{- end }}
{{- end }}
{{- end }}
