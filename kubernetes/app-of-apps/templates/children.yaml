{{/*
Children - rendered when renderParent is set
Creates:
  1. AppProject for the parent
  2. Child Applications (cilium, vault, etc.)

Controlled by: childDefaults + parents.<name>.childDefaults + parents.<name>.children
*/}}
{{- if .Values.renderParent }}
{{- $renderParent := .Values.renderParent }}
{{- $envName := .Values.environment }}
{{- $parentDefaults := .Values.parentDefaults }}
{{- range $parentName, $parentConfig := .Values.parents }}
{{- if eq $parentName $renderParent }}
{{- $prefixNames := $parentConfig.prefixNames | default $parentDefaults.prefixNames }}
{{- $effectiveParentName := $parentName }}
{{- if $prefixNames }}
  {{- $effectiveParentName = printf "%s-%s" $envName $parentName }}
{{- end }}
{{- $excluded := $parentConfig.excludeChildren | default list }}
---
{{ include "app-of-apps.appProject" (list $effectiveParentName ($parentConfig.description | default $parentName) $parentConfig $.Values) }}
{{- range $parentConfig.children }}
{{- if and (ne .enabled false) (not (has .name $excluded)) }}
---
{{ include "app-of-apps.application" (list $ . $parentName $parentConfig) }}
{{- end }}
{{- end }}
{{- range ($parentConfig.extraChildren | default list) }}
{{- if and (ne .enabled false) (not (has .name $excluded)) }}
---
{{ include "app-of-apps.application" (list $ . $parentName $parentConfig) }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
