{{/*
Layer resources - rendered when renderLayer is set
Creates:
  1. AppProject for the layer (e.g., "system", "platform", "applications")
  2. Child Applications belonging to this layer
*/}}
{{- if .Values.global.renderLayer }}
{{- $renderLayer := .Values.global.renderLayer }}
{{- $global := .Values.global }}
{{- range $layerName, $layerConfig := .Values.layers }}
{{- if eq $layerName $renderLayer }}
---
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: {{ $layerName }}
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "-10"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  description: {{ $layerConfig.description | default $layerName | quote }}

  # Source repositories
  sourceRepos:
    {{- range ($layerConfig.sourceRepos | default (list $global.repository.url)) }}
    - {{ . }}
    {{- end }}

  # Destination clusters and namespaces
  destinations:
    {{- range ($layerConfig.destinations | default (list (dict "namespace" "*" "server" $global.destination.server))) }}
    - namespace: {{ .namespace | quote }}
      server: {{ .server }}
    {{- end }}

  # Cluster resource allow list
  clusterResourceWhitelist:
    {{- range ($layerConfig.clusterResourceWhitelist | default (list (dict "group" "*" "kind" "*"))) }}
    - group: {{ .group | quote }}
      kind: {{ .kind | quote }}
    {{- end }}

  # Namespace resource allow list
  namespaceResourceWhitelist:
    {{- range ($layerConfig.namespaceResourceWhitelist | default (list (dict "group" "*" "kind" "*"))) }}
    - group: {{ .group | quote }}
      kind: {{ .kind | quote }}
    {{- end }}

  {{- if $layerConfig.roles }}
  roles:
    {{- toYaml $layerConfig.roles | nindent 4 }}
  {{- else }}
  roles: []
  {{- end }}
{{- range $layerConfig.apps }}
{{- if .enabled }}
---
{{- include "app-of-apps.application" (list $ . $layerName $layerConfig) }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
