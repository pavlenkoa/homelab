# App-of-Apps Chart
#
# Hierarchy:
#   layers.yaml   → projectDefaults, layerDefaults + layers.<name>
#   children.yaml → projectDefaults + layers.<name>.projectDefaults, childDefaults + layers.<name>.childDefaults
#
# Merge rules:
#   - syncPolicy, ignoreDifferences, finalizers: Override (child wins)
#   - additionalSyncOptions, additionalIgnoreDifferences, annotations: Merge

repository:
  url: "https://github.com/pavlenkoa/homelab.git"
  targetRevision: "HEAD"

destination:
  server: "https://kubernetes.default.svc"

# Used by ApplicationSet for app name, and templates for AppProject/valueFiles
environment: ""

# Internal - set via helm parameters by parent Applications
renderLayer: ""

# Defaults for layer Applications (system, platform, applications)
layerDefaults:
  prefixNames: false
  annotations: {}
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
  finalizers:
    - resources-finalizer.argocd.argoproj.io

# Defaults for child Applications (cilium, vault, etc.)
childDefaults:
  annotations: {}
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - ServerSideApply=true
      - ServerSideDiff=true
  additionalIgnoreDifferences:
    - group: apps
      kind: StatefulSet
      jsonPointers:
        - /spec/volumeClaimTemplates/0/metadata/creationTimestamp
        - /spec/volumeClaimTemplates/0/spec/volumeMode
        - /spec/volumeClaimTemplates/0/status
  finalizers:
    - resources-finalizer.argocd.argoproj.io

# Defaults for AppProjects (environment + layer projects)
projectDefaults:
  annotations:
    argocd.argoproj.io/sync-wave: "-10"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  clusterResourceWhitelist:
    - group: "*"
      kind: "*"
  namespaceResourceWhitelist:
    - group: "*"
      kind: "*"
  destinations:
    - namespace: "*"

# Layers
layers:
  system:
    description: "Core cluster components"
    annotations:
      argocd.argoproj.io/sync-wave: "-1"
    syncPolicy:
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
    children:
      - name: cilium
        namespace: kube-system
        annotations:
          argocd.argoproj.io/sync-wave: "-3"
        ignoreDifferences:
          - group: ""
            kind: Secret
            name: cilium-ca
            namespace: kube-system
            jsonPointers:
              - /data
          - group: ""
            kind: Secret
            name: hubble-relay-client-certs
            namespace: kube-system
            jsonPointers:
              - /data
          - group: ""
            kind: Secret
            name: hubble-server-certs
            namespace: kube-system
            jsonPointers:
              - /data
      - name: ingress-nginx
        annotations:
          argocd.argoproj.io/sync-wave: "-2"
      - name: cert-manager
        annotations:
          argocd.argoproj.io/sync-wave: "0"

  platform:
    description: "Platform services and DevOps tools"
    annotations:
      argocd.argoproj.io/sync-wave: "0"
    sourceRepos:
      - "https://github.com/pavlenkoa/homelab.git"
      - "https://github.com/pavlenkoa/vault-secrets-generator.git"
    children:
      - name: vault
        annotations:
          argocd.argoproj.io/sync-wave: "0"
      - name: external-secrets
        annotations:
          argocd.argoproj.io/sync-wave: "0"
      - name: argocd
        annotations:
          argocd.argoproj.io/sync-wave: "1"
      - name: vault-secrets-generator
        enabled: false
        namespace: vsg
        path: helm/vault-secrets-generator
        repository:
          url: "https://github.com/pavlenkoa/vault-secrets-generator.git"
          targetRevision: "HEAD"
        annotations:
          argocd.argoproj.io/sync-wave: "2"
      - name: victoriametrics
        enabled: false
        namespace: monitoring
        annotations:
          argocd.argoproj.io/sync-wave: "2"
      - name: victorialogs
        enabled: false
        namespace: monitoring
        annotations:
          argocd.argoproj.io/sync-wave: "2"
      - name: grafana
        enabled: false
        namespace: monitoring
        annotations:
          argocd.argoproj.io/sync-wave: "2"
      - name: alloy
        enabled: false
        namespace: monitoring
        annotations:
          argocd.argoproj.io/sync-wave: "2"
      - name: n8n
        annotations:
          argocd.argoproj.io/sync-wave: "3"
      - name: authelia
        annotations:
          argocd.argoproj.io/sync-wave: "3"

  applications:
    description: "End-user applications and services"
    annotations:
      argocd.argoproj.io/sync-wave: "1"
    children:
      - name: external-services
        helm:
          valueFiles: []
        annotations:
          argocd.argoproj.io/sync-wave: "4"
      - name: transmission
        directory: {}
        annotations:
          argocd.argoproj.io/sync-wave: "4"
