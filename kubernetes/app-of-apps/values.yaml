# =============================================================================
# APP-OF-APPS CHART VALUES
# =============================================================================
#
# Hierarchy:
#   environment Application (e.g., "homelab")
#   ├── creates: environment AppProject
#   └── creates: layer Applications (system, platform, applications)
#       ├── creates: layer AppProject
#       └── creates: child Applications (cilium, vault, n8n, etc.)
#           └── creates: actual Kubernetes workloads
#
# Merge/Override rules:
#   - syncPolicy:                 Override (child replaces parent)
#   - ignoreDifferences:          Override (child replaces parent)
#   - additionalIgnoreDifferences: Merge (child adds to parent)
#   - additionalSyncOptions:      Merge (child adds to parent)
#   - annotations:                Merge (child adds to parent)
#   - finalizers:                 Override (first non-empty wins)
#
# Smart defaults:
#   - path:      kubernetes/charts/<name>
#   - namespace: <name>
#   - enabled:   true
#
# =============================================================================

# =============================================================================
# INFRASTRUCTURE - used by all Applications
# =============================================================================
repository:
  url: "https://github.com/pavlenkoa/homelab.git"
  targetRevision: "HEAD"

destination:
  server: "https://kubernetes.default.svc"

# Internal - set by parent Applications via helm parameters, don't modify
renderLayer: ""

# =============================================================================
# ENVIRONMENT - settings for the environment Application
# This Application creates: environment AppProject + layer Applications
# =============================================================================
environment:
  # Required - typically set via values/<name>.yaml
  name: ""

  # Prefix project and app names with environment name (e.g., homelab-system)
  prefixNames: false

  annotations: {}

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true

  finalizers:
    - resources-finalizer.argocd.argoproj.io

# =============================================================================
# LAYER DEFAULTS - default settings for layer Applications
# (system, platform, applications)
# These Applications create: layer AppProject + child Applications
# =============================================================================
layerDefaults:
  annotations: {}

  syncPolicy:
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true

  finalizers:
    - resources-finalizer.argocd.argoproj.io

# =============================================================================
# CHILD DEFAULTS - default settings for child Applications
# (cilium, vault, n8n, etc.)
# These Applications create: actual Kubernetes workloads
# =============================================================================
childDefaults:
  annotations: {}

  syncPolicy:
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - ServerSideApply=true
      - ServerSideDiff=true

  # Applied to ALL child apps (additive)
  additionalIgnoreDifferences:
    - group: apps
      kind: StatefulSet
      jqPathExpressions:
        - .spec.volumeClaimTemplates[].metadata.creationTimestamp

  finalizers:
    - resources-finalizer.argocd.argoproj.io

# =============================================================================
# LAYERS
# =============================================================================
layers:
  # ---------------------------------------------------------------------------
  # SYSTEM - Core cluster components (CNI, ingress, certificates)
  # ---------------------------------------------------------------------------
  system:
    description: "Core cluster components"
    annotations:
      argocd.argoproj.io/sync-wave: "-1"

    # Override layerDefaults.syncPolicy
    syncPolicy:
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true

    children:
      - name: cilium
        namespace: kube-system
        annotations:
          argocd.argoproj.io/sync-wave: "-3"
        ignoreDifferences:
          - group: ""
            kind: Secret
            name: cilium-ca
            namespace: kube-system
            jsonPointers:
              - /data
          - group: ""
            kind: Secret
            name: hubble-relay-client-certs
            namespace: kube-system
            jsonPointers:
              - /data
          - group: ""
            kind: Secret
            name: hubble-server-certs
            namespace: kube-system
            jsonPointers:
              - /data

      - name: ingress-nginx
        annotations:
          argocd.argoproj.io/sync-wave: "-2"

      - name: cert-manager
        annotations:
          argocd.argoproj.io/sync-wave: "0"

  # ---------------------------------------------------------------------------
  # PLATFORM - DevOps and management services
  # ---------------------------------------------------------------------------
  platform:
    description: "Platform services and DevOps tools"
    annotations:
      argocd.argoproj.io/sync-wave: "0"

    # Source repos for this layer's AppProject
    sourceRepos:
      - "https://github.com/pavlenkoa/homelab.git"
      - "https://github.com/pavlenkoa/vault-secrets-generator.git"

    children:
      - name: vault
        annotations:
          argocd.argoproj.io/sync-wave: "0"

      - name: external-secrets
        annotations:
          argocd.argoproj.io/sync-wave: "0"

      - name: argocd
        annotations:
          argocd.argoproj.io/sync-wave: "1"

      - name: vault-secrets-generator
        enabled: false
        namespace: vsg
        path: helm/vault-secrets-generator
        repository:
          url: "https://github.com/pavlenkoa/vault-secrets-generator.git"
          targetRevision: "HEAD"
        annotations:
          argocd.argoproj.io/sync-wave: "2"

      - name: victoriametrics
        enabled: false
        namespace: monitoring
        annotations:
          argocd.argoproj.io/sync-wave: "2"

      - name: victorialogs
        enabled: false
        namespace: monitoring
        annotations:
          argocd.argoproj.io/sync-wave: "2"

      - name: grafana
        enabled: false
        namespace: monitoring
        annotations:
          argocd.argoproj.io/sync-wave: "2"

      - name: alloy
        enabled: false
        namespace: monitoring
        annotations:
          argocd.argoproj.io/sync-wave: "2"

      - name: n8n
        annotations:
          argocd.argoproj.io/sync-wave: "3"

      - name: authelia
        annotations:
          argocd.argoproj.io/sync-wave: "3"

  # ---------------------------------------------------------------------------
  # APPLICATIONS - End-user services
  # ---------------------------------------------------------------------------
  applications:
    description: "End-user applications and services"
    annotations:
      argocd.argoproj.io/sync-wave: "1"

    children:
      - name: external-services
        annotations:
          argocd.argoproj.io/sync-wave: "4"
